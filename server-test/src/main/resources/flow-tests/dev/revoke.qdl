#! /usr/bin/env -S qdl-run

/*
   Tests the revocation (and introspection) machinery for a client.
*/
path := os_env('NCSA_DEV_INPUT')+'/oa4mp/server-test/src/main/resources/flow-tests';
if[path∉script_path()][script_path(path ~ script_path());];
cfg.'id'  := 'dev:test/no_cfg';
cfg.'idp'  := 'NCSA';
cfg.'file' := '/home/ncsa/dev/csd/config/client-oa2.xml';
cfg.'description' :=  'Test revocation and introspection machinery for a client.';
cfg.'flow_type' := 'uri'; // Note to use df you need to set param for the token endpoint

rc := script_load('driver.qdl', cfg.);
if[rc!='ok'][return(rc);];

tokens. := clc#access();
// Tests that the start of the PEM format is a substring of the response.
⊨    '---BEGIN CERTIFICATE-----'<clc#get_cert() : 'could not get a cert';

⊨ introspect().'active':'access token not active';
⊨ introspect('-rt').'active':'refresh token not active';
⊨ revoke():'token not revoked';
⊨ !introspect().'active' : 'AT is not active';

try[
  exchange();
  ⊨ false : 'token should be invalid.';
]catch[
];

exchange('-at', '-x'); // Get a new access token for later before we invalidate the refresh token
// RT tests
tokens. := exchange('-rt');
⊨ introspect('-rt').'active':'refresh token not active';
⊨ revoke('-rt'): 'refresh token not revoked';
⊨ !introspect('-rt').'active':'refresh token not active';
try[
  exchange('-rt');
  ⊨ false : 'token should be invalid.';
]catch[
];

 exchange('-at'); // can still get an access token

⊨ introspect().'active':'access token not active';

say('ok');
